{"componentChunkName":"component---src-templates-blog-post-js","path":"/how-create-custom-ical-exports-category-using-drupal-and-views/","result":{"data":{"site":{"siteMetadata":{"author":"Luu Tuan Anh","homeCity":"Hanoi, Vietnam"}},"markdownRemark":{"html":"<p>Lately I’ve been helping out a web development team at BYU develop a new calendaring system in Drupal to replace our <a href=\"http://byunews.byu.edu/calendar/\">existing all-in-one calendar</a>. It’s an ambitious project that’s leveraging quite a few different modules from the Drupalsphere.</p>\n<p>Some of the features include:</p>\n<ul>\n<li>Import ical feeds.</li>\n<li>Filter events for display by event category</li>\n<li>Download customized ical feeds by category (i.e. Student wants to import just sport and academic events into his personal calendar).</li>\n<li>Hovering on event titles exposes tooltip (we’re using <a href=\"http://www.lullabot.com/files/bt/bt-latest/DEMO/index.html\">Beautytips</a>) with full event info</li>\n</ul>\n<p>Here’s a screenshot of the UI as of last night:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7f3f880e96b31454abaa8139c6b7538d/ea7fb/tooltip.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 82.43243243243244%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAADL0lEQVQ4y1VUaXPaSBTU//8F+bxb2a1sdikn8ZmYOMaYcAmB7YAQSEgCHUYgo/sCet8I4kqmqquf5mi9a4YDDS+IoJtOidAPUSQpojRDmGVIkxhFliIjJDl9E2JaTwhZWpRIM4YtsjwHh+PwgxA+iflTBaE0heb7UEgsXKkIjB+IQxsLb47n0ISmqVCUGVYLH2sjwLMTw1pGpQ5nmiZMy4JMGzR9TqxiNtOgajrYmm1bUFUNgycRo7GM/qOImabRGQOGuSAYR9so93MaHWSHB4MBut0uhsMhBEEAz/OvdrvdQe2+hS/VW1Rv7iCNZIwfppB+KFAkFcMHsZybz+fgXC+Cs3Ih9HrodDqlEBNm+GnzfBf9voBejyfuQxRbFEWdvBdg6yO4pojoRT+EnOcF5S/4TajzC17n6GcMPV7AXbuC6+YbNPpvkRXhsQo77Ha7Q1GiKEKr1UKz2aTw2uh2DuiQzebYWrl+3LNybDpPnRC42JPIfg/iPfH+IJjEMRYUv2UsKPETNIRhieF4CpuSresszxossjXiIDxUNElz5NQqTIi1UlEU4KIkw8INsQxzrKIttHWMtuyUEM0NlkEGy0tgbWLYfgqbuNhuD0HuDmH+anNrP0ZLsnE7kFF7UPCgryA5CcbLGLKbQ/e20P0d5gEh3EOhH6bMKyayP4TJBuNS0A1i1AZTXDUEnH1r4qzWwUWjj9O7Lq7bj3hUn9GT5mhTi3RFDU+qTfk61mGP3zwsq8wEP1Tr+PfyBp9uGqh8rqHypY53519xettGazTD1/snfLuXUK2NUecVzKMXTEIHk8ApryOrSkB1UIIluJm5wvvzKv6snOPvj1f46wPh5JL4EpWrW4xMD2s/KtsiS7dQDI/y/QJ9bWGVbFizHD3cwnAVcIvlS+nd25ML/HNWLZmBif/x3ylqfQnGykMQxfBIWLVc7Lb7n0/Aaw5xJM6hm3JyXcf7ixtc1LsU9ndiHp8onwx3/TEE2QI/MTC26cFYJ0iyvFRg1d4eK14UB5vbhAkGignRcKFSBWUnxGwdQSFmmD77mNgbiAsHsr2GTL0YRZtShPUee7JYDqNjH/4PRvyRBEHmc8oAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"tooltip\"\n        title=\"\"\n        src=\"/static/7f3f880e96b31454abaa8139c6b7538d/fcda8/tooltip.png\"\n        srcset=\"/static/7f3f880e96b31454abaa8139c6b7538d/12f09/tooltip.png 148w,\n/static/7f3f880e96b31454abaa8139c6b7538d/e4a3f/tooltip.png 295w,\n/static/7f3f880e96b31454abaa8139c6b7538d/fcda8/tooltip.png 590w,\n/static/7f3f880e96b31454abaa8139c6b7538d/ea7fb/tooltip.png 788w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>I wanted to blog about how we created our ical exports by category as I couldn’t find any documentation about this and it doesn’t work out of the box.</p>\n<p>The default view from Calendar includes an ical display. This, by default, filters ical feeds by date — e.g. only include events in the ical feed after a certain date. This works fine.</p>\n<p>The problem we ran into is how to filter the ical feed by taxonomy terms. In Views we created a taxonomy term filter and exposed that to users so they can created custom calendar views of different event categories. That worked wonderfully. The problem was that when you downloaded the ical feed from the filtered calendar view, it included all events, not just events from the categories you’d selected.</p>\n<p>After examining the url for the ical feed we found the problem.</p>\n<p>The default ical URL that’s generated looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">/aiocalendar/calendar/ical/2009-10?tid[2]=2&amp;tid[1]=1&amp;tid[3]=3&amp;tid[4]=4&amp;tid[5]=5&amp;tid[6]=6&amp;tid[7]=7</code></pre></div>\n<p>Views takes each url segment separated by a forward slash as arguments. <code class=\"language-text\">calendar/ical</code> tells views to return an ical representation of the calendar. <code class=\"language-text\">2009-10</code> tells views to only include events from October 2009 onward. But the next bit, <code class=\"language-text\">?tid[2][2]=2&amp;tid[1][1]=1&amp;tid[3][3]=3&amp;tid[4][4]=4&amp;tid[5]=5&amp;tid[6][5]=6&amp;tid[7][6]=7</code>, a list of term IDs that were currently active on the calendar view, weren’t working at helping Views produced a filtered ical feed.</p>\n<p>Digging into the taxonomy term argument, I discovered it expected arguments in the form of <code class=\"language-text\">1+2+3</code> or <code class=\"language-text\">1,2,3</code>. <code class=\"language-text\">1+2+3</code> meaning Views would return events that had terms <code class=\"language-text\">1 OR 2 OR 3</code> and <code class=\"language-text\">1,2,3</code> meaning Views would return events that had terms <code class=\"language-text\">1 AND 2 AND 3</code>. For example, <code class=\"language-text\">aiocalendar/calendar/ical/2009-10/1+4+6</code> would return an ical feed of all events from October 2009 onward that had term ids of <code class=\"language-text\">1 or 4 or 6</code>.</p>\n<p>I jumped to the command line and tested my theory by using wget and some handcrafted urls and it worked! The ical feeds I was getting only included events from categories I included as arguments in the URL.</p>\n<p>Now the trick was to override the ical url generated to replace it with one in the correct format. I found the theme function in the Calendar module where the the ical feed icon was generated, copied that to my module, and rewrote the url using some regex kungfu (read more <a href=\"http://drupal.org/node/11811\">on overriding theme functions</a> in the <a href=\"http://drupal.org/handbooks\">Drupal handbook</a>).</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token comment\">/*\n * Override theme_calendar_ical_icon() so we can override the url produced.\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">phptemplate_calendar_ical_icon</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Pull out array of Term IDs from the url.</span>\n  <span class=\"token variable\">$search</span> <span class=\"token operator\">=</span> <span class=\"token function\">preg_match_all</span><span class=\"token punctuation\">(</span><span class=\"token double-quoted-string string\">\"/tid\\[([0-9])*\\]/\"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$url</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$matches</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token variable\">$tids</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$matches</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Grab url stem, we'll add the Term ID arguments back in a bit.</span>\n  <span class=\"token variable\">$search</span> <span class=\"token operator\">=</span> <span class=\"token function\">preg_match</span><span class=\"token punctuation\">(</span><span class=\"token double-quoted-string string\">\"/(.*ical\\/)20[0-9]{2}-.*/\"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$url</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$url_stem</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token variable\">$url</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$url_stem</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Views arguments treat a \"+\" between arguments as OR.</span>\n  <span class=\"token comment\">// So we're crafting an argument that asks for all events which match one of the</span>\n  <span class=\"token comment\">// term IDs.</span>\n  <span class=\"token keyword\">foreach</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$tids</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$tid</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$url</span> <span class=\"token punctuation\">.</span><span class=\"token operator\">=</span> <span class=\"token variable\">$tid</span> <span class=\"token punctuation\">.</span> <span class=\"token double-quoted-string string\">\"+\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Trim off extra +</span>\n  <span class=\"token variable\">$url</span> <span class=\"token operator\">=</span> <span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">,</span> <span class=\"token double-quoted-string string\">\"+\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$image</span> <span class=\"token operator\">=</span> <span class=\"token function\">theme</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'image'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">drupal_get_path</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'module'</span><span class=\"token punctuation\">,</span> <span class=\"token single-quoted-string string\">'date_api'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span><span class=\"token single-quoted-string string\">'/images/ical16x16.gif'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'Add to calendar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">t</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'Add to calendar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token single-quoted-string string\">'&lt;div style=\"text-align:right\">&lt;a href=\"'</span><span class=\"token punctuation\">.</span> <span class=\"token function\">check_url</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">.</span><span class=\"token single-quoted-string string\">'\" class=\"ical-icon\" title=\"ical\">'</span><span class=\"token punctuation\">.</span> <span class=\"token variable\">$image</span> <span class=\"token punctuation\">.</span><span class=\"token single-quoted-string string\">'&lt;/a>&lt;/div>'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token delimiter important\">?></span></span></code></pre></div>\n<p>We’ll be releasing our calendar, custom code and all, as a feature on BYU’s own feature server once the new calendar is released to production. But you can grab a development copy of it now at <a href=\"https://island.byu.edu/content/first-upload-calendar-feature\">https://island.byu.edu/content/first-upload-calendar-feature</a></p>\n<p>The BYU Drupal community is collaborating to improve our calendar feature as it solves nicely a common need on the many department web sites deployed on campus. If you’d like to join the <a href=\"https://island.byu.edu/group/drupal-calendar\">Drupal Calendar group</a> to participate, <a href=\"mailto:mathews.kyle@gmail.com\">contact me</a>, and I’ll create an account for you on our groups site.</p>","excerpt":"Lately I’ve been helping out a web development team at BYU develop a new calendaring system in Drupal to replace our existing all-in-one…","fields":{"tagSlugs":["/tags/drupal/"]},"frontmatter":{"title":"How to create custom ical exports by category using Drupal and the Views and Calendar modules","tags":["drupal"],"date":"October 06, 2009"}}},"pageContext":{"slug":"/how-create-custom-ical-exports-category-using-drupal-and-views/"}}}